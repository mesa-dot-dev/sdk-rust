name: CI

on:
  push:
    branches:
      - staged

permissions:
  contents: write

jobs:
  lint-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: staged
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@v2

      - name: Run clippy on mesa-dev
        run: cargo clippy -p mesa-dev --no-deps -- -D warnings

      - name: Check formatting of mesa-dev
        run: cargo fmt -p mesa-dev --check

      - name: Run tests
        timeout-minutes: 10
        env:
          MESA_TEST_API_KEY: ${{ secrets.MESA_TEST_API_KEY }}
          MESA_TEST_ORG: ${{ secrets.MESA_TEST_ORG }}
        run: cargo test --workspace

      - name: Bump minor version
        id: bump
        run: |
          CURRENT_VERSION=$(grep '^version' crates/mesa-dev/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: ${CURRENT_VERSION}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
          echo "New version: ${NEW_VERSION}"

          sed -i "s/^version = \"${CURRENT_VERSION}\"/version = \"${NEW_VERSION}\"/" crates/mesa-dev/Cargo.toml

          OAPI_CURRENT_VERSION=$(grep '^version' crates/mesa-dev-oapi/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Current mesa_dev_oapi version: ${OAPI_CURRENT_VERSION}"

          IFS='.' read -r OAPI_MAJOR OAPI_MINOR OAPI_PATCH <<< "$OAPI_CURRENT_VERSION"
          OAPI_NEW_PATCH=$((OAPI_PATCH + 1))
          OAPI_NEW_VERSION="${OAPI_MAJOR}.${OAPI_MINOR}.${OAPI_NEW_PATCH}"
          echo "New mesa_dev_oapi version: ${OAPI_NEW_VERSION}"

          sed -i "s/^version = \"${OAPI_CURRENT_VERSION}\"/version = \"${OAPI_NEW_VERSION}\"/" crates/mesa-dev-oapi/Cargo.toml

          # Update Cargo.lock to reflect the new versions
          cargo check -p mesa-dev

          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Commit and push version bump
        run: |
          git config user.name "mesa-ci[bot]"
          git config user.email "ci-bot@mesa.dev"

          git add crates/mesa-dev/Cargo.toml crates/mesa-dev-oapi/Cargo.toml Cargo.lock
          git commit -m "Bump mesa-dev to ${{ steps.bump.outputs.new_version }}"
          git push origin staged

      - name: Fast-forward merge staged into main
        run: |
          git checkout main
          git merge --ff-only staged
          git push origin main

  on-failure:
    runs-on: ubuntu-latest
    if: ${{ always() && (needs.lint-and-release.result == 'failure' || needs.lint-and-release.result == 'timed_out') }}
    needs:
      - lint-and-release
    steps:
    - uses: actions/checkout@v2
    - name: Slack Notification
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_USERNAME: mesa-gh
        SLACK_TITLE: Workflow ${{ needs.lint-and-release.result }}
        MSG_MINIMAL: actions url
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
